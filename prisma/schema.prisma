// Clinic Management System - Prisma Schema
// Database: MongoDB (Atlas)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// =========================================
// CLINIC SETTINGS
// =========================================

model ClinicSettings {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String   @default("ຄລີນິກ ສຸຂະພາບດີ")
  subtitle  String?  @default("ຜູ້ບໍລິການ")
  logo      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("clinic_settings")
}

model ContactInfo {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  phone        String?
  email        String?
  facebook     String?
  line         String?
  website      String?
  address      String?
  province     String?  @default("ນະຄອນຫຼວງວຽງຈັນ")
  district     String?
  village      String?
  openingHours String?
  mapUrl       String?
  description  String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("contact_info")
}

// =========================================
// USER & AUTHENTICATION
// =========================================

enum UserRole {
  ADMIN
  EMPLOYEE
}

model User {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  username  String   @unique
  password  String
  name      String
  role      UserRole @default(EMPLOYEE)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sales Sale[]

  @@map("users")
}

// =========================================
// CUSTOMER MANAGEMENT
// =========================================

model Customer {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  firstName String   @map("first_name")
  lastName  String   @map("last_name")
  phone     String   @unique
  age       Int?
  province  String?
  district  String?
  village   String?
  image     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sales Sale[]

  @@map("customers")
}

// =========================================
// PRODUCT & INVENTORY MANAGEMENT
// =========================================

model ProductCategory {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String   @unique
  unit      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  products Product[]

  @@map("product_categories")
}

model Product {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?
  price       Float
  costPrice   Float    @map("cost_price")
  stock       Int      @default(0)
  minStock    Int      @default(5) @map("min_stock")
  categoryId  String   @map("category_id") @db.ObjectId
  images      Json?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  category  ProductCategory @relation(fields: [categoryId], references: [id])
  saleItems SaleItem[]

  @@map("products")
}

// =========================================
// SERVICES MANAGEMENT
// =========================================

model Service {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?
  price       Float
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  saleItems SaleItem[]

  @@map("services")
}

// =========================================
// PROMOTIONS
// =========================================

model Promotion {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?
  discount    Float
  isPercent   Boolean  @default(false) @map("is_percent")
  startDate   DateTime @map("start_date")
  endDate     DateTime @map("end_date")
  images      Json?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  sales Sale[]

  @@map("promotions")
}

// =========================================
// SALES & INVOICES
// =========================================

enum PaymentStatus {
  PAID
  UNPAID
  TRANSFER
}

model Sale {
  id            String        @id @default(auto()) @map("_id") @db.ObjectId
  invoiceNumber String        @unique @map("invoice_number")
  customerId    String        @map("customer_id") @db.ObjectId
  userId        String        @map("user_id") @db.ObjectId
  promotionId   String?       @map("promotion_id") @db.ObjectId
  subtotal      Float
  discount      Float         @default(0)
  total         Float
  status        PaymentStatus @default(UNPAID)
  notes         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  customer  Customer   @relation(fields: [customerId], references: [id])
  user      User       @relation(fields: [userId], references: [id])
  promotion Promotion? @relation(fields: [promotionId], references: [id])
  items     SaleItem[]

  @@map("sales")
}

model SaleItem {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  saleId    String   @map("sale_id") @db.ObjectId
  productId String?  @map("product_id") @db.ObjectId
  serviceId String?  @map("service_id") @db.ObjectId
  quantity  Int      @default(1)
  price     Float
  total     Float
  createdAt DateTime @default(now())

  sale    Sale     @relation(fields: [saleId], references: [id])
  product Product? @relation(fields: [productId], references: [id])
  service Service? @relation(fields: [serviceId], references: [id])

  @@map("sale_items")
}

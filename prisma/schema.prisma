// Clinic Management System - Prisma Schema
// Database: MySQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// =========================================
// CLINIC SETTINGS
// =========================================

model ClinicSettings {
  id        Int      @id @default(autoincrement())
  name      String   @default("ຄລີນິກ ສຸຂະພາບດີ")
  subtitle  String?  @default("ຜູ້ບໍລິການ")
  logo      String? // Path to logo image
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("clinic_settings")
}

model ContactInfo {
  id           Int      @id @default(autoincrement())
  phone        String?  @db.Text // Contact phone numbers (JSON array)
  email        String?
  facebook     String?
  line         String?
  website      String?
  address      String?  @db.Text
  province     String?  @default("ນະຄອນຫຼວງວຽງຈັນ")
  district     String?
  village      String?
  openingHours String?  @db.Text // JSON format for opening hours
  mapUrl       String?  @db.Text // Google Maps embed URL
  description  String?  @db.Text
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("contact_info")
}

// =========================================
// USER & AUTHENTICATION
// =========================================

enum UserRole {
  ADMIN
  EMPLOYEE
}

model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  password  String
  name      String
  role      UserRole @default(EMPLOYEE)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sales Sale[]

  @@map("users")
}

// =========================================
// CUSTOMER MANAGEMENT
// =========================================

model Customer {
  id        Int      @id @default(autoincrement())
  firstName String   @map("first_name")
  lastName  String   @map("last_name")
  phone     String   @unique
  age       Int? // ອາຍຸ
  province  String? // ແຂວງ
  district  String? // ເມືອງ
  village   String? // ບ້ານ
  image     String? // ຮູບພາບ
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sales Sale[]

  @@map("customers")
}

// =========================================
// PRODUCT & INVENTORY MANAGEMENT
// =========================================

model ProductCategory {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  unit      String // ເມັດ, ແຜ່ນ, ອັນ, ຖົງ
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  products Product[]

  @@map("product_categories")
}

model Product {
  id          Int      @id @default(autoincrement())
  name        String
  description String?  @db.Text
  price       Decimal  @db.Decimal(10, 2)
  costPrice   Decimal  @map("cost_price") @db.Decimal(10, 2)
  stock       Int      @default(0)
  minStock    Int      @default(5) @map("min_stock") // Alert threshold
  categoryId  Int      @map("category_id")
  images      Json? // Array of image paths
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  category  ProductCategory @relation(fields: [categoryId], references: [id])
  saleItems SaleItem[]

  @@map("products")
}

// =========================================
// SERVICES MANAGEMENT
// =========================================

model Service {
  id          Int      @id @default(autoincrement())
  name        String
  description String?  @db.Text
  price       Decimal  @db.Decimal(10, 2)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  saleItems SaleItem[]

  @@map("services")
}

// =========================================
// PROMOTIONS
// =========================================

model Promotion {
  id          Int      @id @default(autoincrement())
  name        String
  description String?  @db.Text
  discount    Decimal  @db.Decimal(10, 2) // Amount or percentage
  isPercent   Boolean  @default(false) @map("is_percent")
  startDate   DateTime @map("start_date")
  endDate     DateTime @map("end_date")
  images      Json? // Array of image paths
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  sales Sale[]

  @@map("promotions")
}

// =========================================
// SALES & INVOICES
// =========================================

enum PaymentStatus {
  PAID
  UNPAID
  TRANSFER
}

model Sale {
  id            Int           @id @default(autoincrement())
  invoiceNumber String        @unique @map("invoice_number")
  customerId    Int           @map("customer_id")
  userId        Int           @map("user_id")
  promotionId   Int?          @map("promotion_id")
  subtotal      Decimal       @db.Decimal(10, 2)
  discount      Decimal       @default(0) @db.Decimal(10, 2)
  total         Decimal       @db.Decimal(10, 2)
  status        PaymentStatus @default(UNPAID)
  notes         String?       @db.Text
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  customer  Customer   @relation(fields: [customerId], references: [id])
  user      User       @relation(fields: [userId], references: [id])
  promotion Promotion? @relation(fields: [promotionId], references: [id])
  items     SaleItem[]

  @@map("sales")
}

model SaleItem {
  id        Int      @id @default(autoincrement())
  saleId    Int      @map("sale_id")
  productId Int?     @map("product_id")
  serviceId Int?     @map("service_id")
  quantity  Int      @default(1)
  price     Decimal  @db.Decimal(10, 2)
  total     Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now())

  sale    Sale     @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id])
  service Service? @relation(fields: [serviceId], references: [id])

  @@map("sale_items")
}
